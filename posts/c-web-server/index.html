<!DOCTYPE html><html lang="en-US" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.3.3" /><meta property="og:title" content="Building a Simple Web Server in C - an open source project" /><meta name="author" content="Ian Y.E. Pan" /><meta property="og:locale" content="en_US" /><meta name="description" content="This Github repo is a well-designed small project to learn about web servers in C. A lot of the heavy lifting data structures and basic interactions using the socket API have been given to us. The focus of this project is to build an HTTP request parser, an HTTP response builder, and an LRU cache consisting of a doubly linked list and a hash table. Understanding the given code is also pretty much a prerequisite, otherwise it’d be hard to understand the code abstractions and the instructions on what to implement." /><meta property="og:description" content="This Github repo is a well-designed small project to learn about web servers in C. A lot of the heavy lifting data structures and basic interactions using the socket API have been given to us. The focus of this project is to build an HTTP request parser, an HTTP response builder, and an LRU cache consisting of a doubly linked list and a hash table. Understanding the given code is also pretty much a prerequisite, otherwise it’d be hard to understand the code abstractions and the instructions on what to implement." /><link rel="canonical" href="https://ianyepan.github.io/posts/c-web-server/" /><meta property="og:url" content="https://ianyepan.github.io/posts/c-web-server/" /><meta property="og:site_name" content="Ian Y.E. Pan" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2023-05-07T09:30:00+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Building a Simple Web Server in C - an open source project" /><meta name="twitter:site" content="@" /><meta name="twitter:creator" content="@Ian Y.E. Pan" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Ian Y.E. Pan"},"dateModified":"2023-05-08T07:34:23+08:00","datePublished":"2023-05-07T09:30:00+08:00","description":"This Github repo is a well-designed small project to learn about web servers in C. A lot of the heavy lifting data structures and basic interactions using the socket API have been given to us. The focus of this project is to build an HTTP request parser, an HTTP response builder, and an LRU cache consisting of a doubly linked list and a hash table. Understanding the given code is also pretty much a prerequisite, otherwise it’d be hard to understand the code abstractions and the instructions on what to implement.","headline":"Building a Simple Web Server in C - an open source project","mainEntityOfPage":{"@type":"WebPage","@id":"https://ianyepan.github.io/posts/c-web-server/"},"url":"https://ianyepan.github.io/posts/c-web-server/"}</script><title>Building a Simple Web Server in C - an open source project | Ian Y.E. Pan</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Ian Y.E. Pan"><meta name="application-name" content="Ian Y.E. Pan"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/unregister.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="https://avatars.githubusercontent.com/u/36686900?v=4" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Ian Y.E. Pan</a></div><div class="site-subtitle font-italic">software engineer, emacs enthusiast, keyboard lover. occasionally nerdy.</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT ME</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/ianyepan" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://www.linkedin.com/in/ianyepan/" aria-label="linkedin" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['ian.pan','columbia.edu'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always use light mode by default: Experimental */ /* self.setLight(); */ /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>Building a Simple Web Server in C - an open source project</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Building a Simple Web Server in C - an open source project</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> Ian Y.E. Pan </span> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Sun, May 7, 2023, 9:30 AM +0800" prep="on" > May 7, 2023 <i class="unloaded">2023-05-07T09:30:00+08:00</i> </span></div><div> <span> <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Sun, May 7, 2023, 4:34 PM -0700" prefix="Updated " > May 7, 2023 <i class="unloaded">2023-05-08T07:34:23+08:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1578 words">8 min</span></div></div><div class="post-content"><p>This <a href="https://github.com/bloominstituteoftechnology/C-Web-Server">Github repo</a> is a well-designed small project to learn about web servers in C. A lot of the heavy lifting data structures and basic interactions using the socket API have been given to us. The focus of this project is to build an HTTP request parser, an HTTP response builder, and an LRU cache consisting of a doubly linked list and a hash table. Understanding the given code is also pretty much a prerequisite, otherwise it’d be hard to understand the code abstractions and the instructions on what to implement.</p><p>The given skeleton code is well-documented, and the README even includes some background reading for networking and LRU caches.</p><p>All in all, it’s a nice little project that takes no longer than one or two evenings to finish (provided that your know C well).</p><p>In this blog post, I want to talk about some of the challenges to look out for, funny bugs I made, and how I solved them.</p><h2 id="caveats-when-sending-header-and-body-of-a-http-response">Caveats when sending header and body of a HTTP response</h2><p>One of the first tasks in this project is to complete the function <code class="language-plaintext highlighter-rouge">send_response</code> with the following prototype:</p><div class="language-c highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="kt">int</span> <span class="nf">send_response</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">header</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">content_type</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">body</span><span class="p">,</span> <span class="kt">int</span> <span class="n">content_length</span><span class="p">);</span>
</pre></table></code></div></div><p>where <code class="language-plaintext highlighter-rouge">fd</code> is the listening socket returned by the <code class="language-plaintext highlighter-rouge">socket()</code> function from <code class="language-plaintext highlighter-rouge">sys/socket.h</code>.</p><p>We want to create a response and send it using the <code class="language-plaintext highlighter-rouge">send()</code> function (again, from <code class="language-plaintext highlighter-rouge">sys/socket.h</code>). The response has the following format:</p><pre><code class="language-log">HTTP/1.1 200 OK
Date: Sat May 6 21:05:11 PST 2023
Connection: close
Content-Length: 31740
Content-Type: text/html

&lt;!DOCTYPE html&gt;&lt;html&gt;&lt;head&gt;&lt;title&gt;Example page ...
</code></pre><p>I immediately thought of constructing the response string using <code class="language-plaintext highlighter-rouge">snprintf()</code>, which is the closest thing we get in C that’s roughly on par with C++’s stringstream, or Python’s f-string.</p><p>I coded the following solution, but the response would only be correctly received by localhost if the response body is plain text (or html). If it were a PNG image, the page would crash.</p><div class="language-c highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre><span class="p">...</span>
<span class="n">response_length</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">response</span><span class="p">,</span>
                           <span class="n">max_len</span><span class="p">,</span>
                           <span class="s">"%s</span><span class="se">\n</span><span class="s">"</span>
                           <span class="s">"Date: %s"</span>
                           <span class="s">"Connection: close</span><span class="se">\n</span><span class="s">"</span>
                           <span class="s">"Content-Length: %d</span><span class="se">\n</span><span class="s">"</span>
                           <span class="s">"Content-Type: %s</span><span class="se">\n</span><span class="s">"</span>
                           <span class="s">"</span><span class="se">\n</span><span class="s">%s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
                           <span class="n">header</span><span class="p">,</span> <span class="n">date_string</span><span class="p">,</span> <span class="n">content_length</span><span class="p">,</span> <span class="n">content_type</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">body</span><span class="p">);</span>
                           
<span class="n">rv</span> <span class="o">=</span> <span class="n">send</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">reponse_length</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
<span class="p">}</span>
<span class="p">...</span>
</pre></table></code></div></div><p>Could you see the problem? I was treating <code class="language-plaintext highlighter-rouge">void *body</code> as a string and thought I could simply format it as part of my response, which itself is a <code class="language-plaintext highlighter-rouge">char *</code>.</p><p>However, If we try to copy binary data (such as a PNG file) directly into a string using <code class="language-plaintext highlighter-rouge">snprintf()</code>, it will stop at the first occurrence of the null character, truncating the data and potentially corrupting it. One way to solve it is to send the header and body separately, like so (I’m sort of abusing the term “header” here because the <code class="language-plaintext highlighter-rouge">header</code> variable technically only contains the first line of the header, which is <code class="language-plaintext highlighter-rouge">HTTP/1.1 200 OK</code> or <code class="language-plaintext highlighter-rouge">HTTP/1.1 404 NOT FOUND</code>. While <code class="language-plaintext highlighter-rouge">header_length</code> is the size of the full header, including content type, content length, and date, etc.):</p><div class="language-c highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><td class="rouge-code"><pre><span class="n">header_length</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">max_response_size</span><span class="p">,</span>
                         <span class="s">"%s</span><span class="se">\n</span><span class="s">"</span>
                         <span class="s">"Date: %s</span><span class="se">\n</span><span class="s">"</span>
                         <span class="s">"Connection: close</span><span class="se">\n</span><span class="s">"</span>
                         <span class="s">"Content-Length: %d</span><span class="se">\n</span><span class="s">"</span>
                         <span class="s">"Content-Type: %s</span><span class="se">\n</span><span class="s">"</span>
                         <span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
                         <span class="n">header</span><span class="p">,</span> <span class="n">date_string</span><span class="p">,</span> <span class="n">content_length</span><span class="p">,</span> <span class="n">content_type</span><span class="p">);</span>

<span class="n">rv</span> <span class="o">=</span> <span class="n">send</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">header_length</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
<span class="p">}</span>

<span class="n">rv</span> <span class="o">=</span> <span class="n">send</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">body</span><span class="p">,</span> <span class="n">content_length</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
<span class="p">}</span>
<span class="p">...</span>
</pre></table></code></div></div><p>Alternatively, we could use <code class="language-plaintext highlighter-rouge">memcpy()</code> to “force” append the full binary data as part of the response, without having it stop at the first occurrence of a null character. In other words, <code class="language-plaintext highlighter-rouge">memcpy()</code> is a function that copies a specified number of bytes from one memory location to another, regardless of their contents. It does not care if the data being copied contains null characters or any other byte value.</p><p>The <code class="language-plaintext highlighter-rouge">memcpy()</code> method would look as such:</p><div class="language-c highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre><span class="n">header_length</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">max_response_size</span><span class="p">,</span>
                         <span class="s">"%s</span><span class="se">\n</span><span class="s">"</span>
                         <span class="s">"Date: %s</span><span class="se">\n</span><span class="s">"</span>
                         <span class="s">"Connection: close</span><span class="se">\n</span><span class="s">"</span>
                         <span class="s">"Content-Length: %d</span><span class="se">\n</span><span class="s">"</span>
                         <span class="s">"Content-Type: %s</span><span class="se">\n</span><span class="s">"</span>
                         <span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
                         <span class="n">header</span><span class="p">,</span> <span class="n">date_string</span><span class="p">,</span> <span class="n">content_length</span><span class="p">,</span> <span class="n">content_type</span><span class="p">);</span>

<span class="n">memcpy</span><span class="p">(</span><span class="n">response</span> <span class="o">+</span> <span class="n">header_length</span><span class="p">,</span> <span class="n">body</span><span class="p">,</span> <span class="n">content_length</span><span class="p">);</span>

<span class="n">rv</span> <span class="o">=</span> <span class="n">send</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">header_length</span> <span class="o">+</span> <span class="n">content_length</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Note that the destination of <code class="language-plaintext highlighter-rouge">memcpy()</code> (the first argument) is the end of <code class="language-plaintext highlighter-rouge">response</code>, effectly appending the full body right after header. Also note that an extra new line character is needed between the header and the body (two <code class="language-plaintext highlighter-rouge">'\n'</code> in a row).</p><h2 id="caution-always-initialize-your-struct-members">Caution: Always initialize your struct members!</h2><p>I ran into a seemingly weird bug when running several unit tests in a row. Each unit test is supposed to free the “cache” when it’s done checking its own set of assertions, and the next unit test would instantiate a new cache for further checks.</p><p>My unit tests keep failing because later unit tests would “remember” the size (which is a member of <code class="language-plaintext highlighter-rouge">struct cache</code>) of the last freed cache in the previous unit test. How could that be? We are freeing the cache every time a unit test finishes! I checked my <code class="language-plaintext highlighter-rouge">free_cache()</code> implementation and it looked fine. After an hour of debugging, I finally realized that I forgot to initialize the size of the cache when I created a new cache.</p><p>What happened was that the cache in the previous unit test was correctly freed, and the C compiler was smart enough to allocate the new cache in the next unit test at the exact same memory address as before. But since I forgot to initialize the <code class="language-plaintext highlighter-rouge">size</code> of <code class="language-plaintext highlighter-rouge">struct cache</code> during instantiation, the <code class="language-plaintext highlighter-rouge">size</code> member carried over the value of the previous <code class="language-plaintext highlighter-rouge">size</code>. Had I, for whatever reason, reset the <code class="language-plaintext highlighter-rouge">size</code> to zero before I freed the cache, then I might never have found the bug during unit testing (which would definitely backfire some other time). A blessing in disguise, I suppose.</p><h2 id="free-your-malloced-variables-and-nothing-else">Free your malloc’ed variables, and nothing else</h2><p>Our cache structure looks as follows:</p><div class="language-c highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="k">struct</span> <span class="n">cache_entry</span> <span class="p">{</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">content_type</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">content_length</span><span class="p">;</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">content</span><span class="p">;</span>

    <span class="k">struct</span> <span class="n">cache_entry</span> <span class="o">*</span><span class="n">prev</span><span class="p">,</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>  <span class="c1">// Doubly-linked list</span>
<span class="p">};</span>
</pre></table></code></div></div><p>In this project, cache entries are dynamically allocated and initialized like so:</p><div class="language-c highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre><span class="k">struct</span> <span class="n">cache_entry</span> <span class="o">*</span><span class="nf">alloc_entry</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">content_type</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">content</span><span class="p">,</span> <span class="kt">int</span> <span class="n">content_length</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">cache_entry</span> <span class="o">*</span><span class="n">new_entry</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">new_entry</span><span class="p">));</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">new_entry</span><span class="p">)</span> <span class="p">{</span>
        <span class="p">...</span>
    <span class="p">}</span>

    <span class="n">new_entry</span><span class="o">-&gt;</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span><span class="p">;</span>
    <span class="n">new_entry</span><span class="o">-&gt;</span><span class="n">content_type</span> <span class="o">=</span> <span class="n">content_type</span><span class="p">;</span>
    <span class="n">new_entry</span><span class="o">-&gt;</span><span class="n">content</span> <span class="o">=</span> <span class="n">content</span><span class="p">;</span>
    <span class="n">new_entry</span><span class="o">-&gt;</span><span class="n">content_length</span> <span class="o">=</span> <span class="n">content_length</span><span class="p">;</span>
    <span class="n">new_entry</span><span class="o">-&gt;</span><span class="n">prev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">new_entry</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="k">return</span> <span class="n">new_entry</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Notice that we are not dynamically allocating the string members of <code class="language-plaintext highlighter-rouge">struct cache_entry</code>, but rather just the struct itself. This means that when we want to free the cache entry, we just had to call <code class="language-plaintext highlighter-rouge">free(cache_entry)</code> and do not need to first free its members. If instead we explicitly tried to free the members, the compiler will throw an error saying that we attempted to free an invalid pointer.</p><p>However, if the members were indeed malloc’ed, then it’s vital that we free the struct members first before we free the struct. Among the struct members, it generally does not matter which order we free them. However, the best practice would be that we free the members in the reversed order of how they were allocated.</p><h2 id="a-few-words-before-you-start">A few words before you start…</h2><p>If you plan to do this project (which I highly recommend – won’t take longer than a couple of hours), I’d like to give you a head start on the given skeleton code.</p><p>In general, there’s only one cache structure when the program is running, and the cache has one hash table, and one doubly linked list. The struct is defined as follows:</p><div class="language-c highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="k">struct</span> <span class="n">cache</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">hashtable</span> <span class="o">*</span><span class="n">index</span><span class="p">;</span>          <span class="c1">// Hash table</span>
    <span class="k">struct</span> <span class="n">cache_entry</span> <span class="o">*</span><span class="n">head</span><span class="p">,</span> <span class="o">*</span><span class="n">tail</span><span class="p">;</span>  <span class="c1">// Doubly-linked list</span>
    <span class="kt">int</span> <span class="n">max_size</span><span class="p">;</span>                     <span class="c1">// Maxiumum number of entries</span>
    <span class="kt">int</span> <span class="n">cur_size</span><span class="p">;</span>                     <span class="c1">// Current number of entries</span>
<span class="p">};</span>
</pre></table></code></div></div><p>The hash table is inconveniently named <code class="language-plaintext highlighter-rouge">index</code>, which might confuse some people as we normally thought of an index as a number. Here, the index rather has the meaning of “record”. The cache, with its hash table and doubly linked list, stores multiple cache “entries”. The doubly-linked list is useful to quickly remove the tail, move an entry to the head, or insert a new head, all frequent operations we would do with an LRU cache. The hash table is helpful to swiftly look up the entry pointer given a request file path (serving as the key to the hash table).</p><ul><li><p>When constructing the response, <code class="language-plaintext highlighter-rouge">snprintf()</code> might come in handy.</p><li><p>When parsing the request, <code class="language-plaintext highlighter-rouge">sscanf()</code> might come in handy.</p><li><p>To determine the content type (MIME type), the skeleton code has a handy function: <code class="language-plaintext highlighter-rouge">mime_type_get()</code> which takes a file path, extracts and maps its extension to the correct MIME type.</p><li><p>Here’s a helper function I wrote to format the date of the response header:</p><div class="language-c highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="c1">// #include &lt;time.h&gt;</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">populate_date_string</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">max_len</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">time_t</span> <span class="n">rawtime</span> <span class="o">=</span> <span class="n">time</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
    <span class="k">struct</span> <span class="n">tm</span> <span class="o">*</span><span class="n">timeinfo</span> <span class="o">=</span> <span class="n">localtime</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rawtime</span><span class="p">);</span>
  
    <span class="n">strftime</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">max_len</span><span class="p">,</span> <span class="s">"%a, %d %b %Y %H:%M:%S %Z"</span><span class="p">,</span> <span class="n">timeinfo</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><p>To use it, you should specify a char array with maximum date length and pass it into this void function.</p></ul><h2 id="conclusion">Conclusion</h2><p>C-Web-Server is a fun little project to practice C programming while reviewing concepts such as LRU cache, memory management, and the HTTP protocol. I hope you enjoyed reading this post, and are maybe thinking about finishing this project yourself!</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/programming/'>Programming</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/programming/" class="post-tag no-text-decoration" >programming</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Building a Simple Web Server in C - an open source project - Ian Y.E. Pan&url=https://ianyepan.github.io/posts/c-web-server/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Building a Simple Web Server in C - an open source project - Ian Y.E. Pan&u=https://ianyepan.github.io/posts/c-web-server/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Building a Simple Web Server in C - an open source project - Ian Y.E. Pan&url=https://ianyepan.github.io/posts/c-web-server/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/system-default-monospace-fonts-pt1/">Gentle Intro to System Default Monospace Fonts (Part 1/2)</a><li><a href="/posts/cpp-notes-pt2/">A Tour of C++ - Reading Notes (Part 2/2)</a><li><a href="/posts/cpp-notes-pt1/">A Tour of C++ - Reading Notes (Part 1/2)</a><li><a href="/posts/c-web-server/">Building a Simple Web Server in C - an open source project</a><li><a href="/posts/sticky-notes/">Syncing Sticky Notes Between Laptop and Mobile</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/programming/">programming</a> <a class="post-tag" href="/tags/tips/">tips</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/emacs/">emacs</a> <a class="post-tag" href="/tags/tutorial/">tutorial</a> <a class="post-tag" href="/tags/workflow/">workflow</a> <a class="post-tag" href="/tags/chinese/">chinese</a> <a class="post-tag" href="/tags/fonts/">fonts</a> <a class="post-tag" href="/tags/essay/">essay</a> <a class="post-tag" href="/tags/fragrance/">fragrance</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/emacs-ide/"><div class="card-body"> <span class="timeago small" > Feb 11, 2022 <i class="unloaded">2022-02-11T09:18:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Building an Intelligent Emacs</h3><div class="text-muted small"><p> This post introduces the combination of Emacs and LSP, and how you can make your own editor “smarter” by using the same idea of communications between an editor client and multiple language serv...</p></div></div></a></div><div class="card"> <a href="/posts/emacs-emojis/"><div class="card-body"> <span class="timeago small" > Feb 17, 2022 <i class="unloaded">2022-02-17T11:18:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Native Emojis in Emacs</h3><div class="text-muted small"><p> This short post will help you set up emoji support in Emacs. First, let’s see the results: Emacs showing emojis Step one, you must have an emoji font installed. I really adore the new fluent de...</p></div></div></a></div><div class="card"> <a href="/posts/emacs-git-gutter/"><div class="card-body"> <span class="timeago small" > Feb 18, 2022 <i class="unloaded">2022-02-18T03:00:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Git Gutter in Emacs</h3><div class="text-muted small"><p> When I first started programming using Visual Studio Code, I’ve benefited much from the git gutter indicators that show added/deleted/modified code blocks that haven’t been committed by git. This a...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/noble-scarlet-ms-yahei/" class="btn btn-outline-primary" prompt="Older"><p>新版微軟雅黑，以及在 Windows 上優化中文顯示的多種技巧</p></a> <span class="btn btn-outline-primary disabled" prompt="Newer"><p>-</p></span></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2024 <a href="https://github.com/ianyepan">Ian Y.E. Pan</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Source code to this website can be found <a href="https://github.com/ianyepan/ianyepan.github.io">here.</a></p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/programming/">programming</a> <a class="post-tag" href="/tags/tips/">tips</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/emacs/">emacs</a> <a class="post-tag" href="/tags/tutorial/">tutorial</a> <a class="post-tag" href="/tags/workflow/">workflow</a> <a class="post-tag" href="/tags/chinese/">chinese</a> <a class="post-tag" href="/tags/fonts/">fonts</a> <a class="post-tag" href="/tags/essay/">essay</a> <a class="post-tag" href="/tags/fragrance/">fragrance</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://ianyepan.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
